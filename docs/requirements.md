# 要件

## 機能要件

### 1. 環境構成

以下4環境を明確に分離すること。

| 環境 | ブランチ | 目的 |
|------|----------|------|
| Development | feature/* | ローカル開発 |
| Preview | PR | 動作確認 |
| Staging | develop | 統合テスト |
| Production | main | 本番運用 |

- 環境間でDB・環境変数は完全分離すること
- StagingとProductionは同一構造であること
- 本番DBへ直接接続する設定をローカルに含めないこと

---

### 2. ローカル開発環境

Docker Composeにより以下を起動できること：

- Next.js フロントエンド
- Go(Gin) バックエンド
- PostgreSQL 15

#### 必須条件
- DBバージョンは本番と一致
- DBは永続ボリュームを持つ
- DBヘルスチェックを実装すること
- backendはdbがhealthyになるまで起動しないこと
- JWT_SECRETは.env経由で注入すること（直書き禁止）

#### 禁止事項
- パスワードのハードコード
- JWT_SECRETのGit管理
- 本番環境変数の流用

---

### 3. 複数アカウント動作確認要件（Issue #9）

複数アカウントを前提とした動作保証を必須とする。

#### 3.1 シードデータ

開発環境に以下のアカウントを自動生成可能であること：

- 管理者アカウント
- 一般ユーザーA
- 一般ユーザーB

手動登録に依存しないこと。

---

#### 3.2 分離保証

以下が成立すること：

1. JWTにより他アカウントのデータへアクセス不可
2. 他ユーザーの投稿・情報が一覧に混在しない
3. APIレイヤーでuser_idによるフィルタを強制
4. 管理者権限の誤使用が発生しない

---

#### 3.3 テスト観点

最低限以下を確認：

- 同時ログイン（別ブラウザ）
- ログアウト → 別ユーザーで再ログイン
- トークン失効時の挙動
- 改ざんトークンの拒否

トークン署名検証を必須とする。

---

### 4. CI/CD要件

GitHub Actionsで以下を実施：

- PR時にテスト実行
- developマージ時にStaging自動デプロイ
- mainマージ時にProduction自動デプロイ

#### CI必須条件

- テスト用PostgreSQLを起動
- テストDBは本番と同バージョン
- マイグレーションをCI内で実行
- テスト失敗時はデプロイ不可

---

### 5. バックエンドデプロイ要件

Go(Gin)バックエンドはDockerイメージとしてビルド可能であること。

必須条件：

- 本番ビルドでGIN_MODE=release
- 環境変数によるDB接続
- ヘルスチェックエンドポイント実装（/health）

---

### 6. データベース要件

#### 環境別分離

- Development: Docker PostgreSQL
- Staging: Managed DB
- Production: Managed DB

StagingとProductionは同一エンジン・同一メジャーバージョン。

---

#### マイグレーション

以下いずれかを必須：

- golang-migrate
- Prisma migrate

AutoMigrateのみで本番運用しないこと。

理由：
スキーマ差分事故防止のため。

---

### 7. 環境変数管理

- .env.localはgitignore対象
- Vercel / ホスティング側で本番変数管理
- JWT_SECRETは最低32文字以上
- 環境ごとに異なる値を設定

---

## 非機能要件

### セキュリティ

- JWT署名検証必須
- アルゴリズム固定（alg=none禁止）
- HTTPS通信必須（Staging/Production）
- DB接続はTLS必須（本番）

---

### 可用性

- Backendにヘルスチェック実装
- DB接続失敗時は即panicせずエラー返却

---

### 再現性

- docker compose up で起動可能
- seedコマンドで初期データ投入可能
- READMEに手順明記

---

### 監査性

- 本番デプロイはCI経由のみ
- 手動サーバー反映禁止

---

## 追記

本要件の最優先事項は：

「複数アカウント環境でデータ分離が完全に保証されること」

UI改善やパフォーマンス最適化は本要件外とする。